FROM ubuntu:latest as BUILDER

WORKDIR /app/

COPY ./ ./

RUN apt-get update && apt-get -y install build-essential wget zlib1g-dev && bash scripts/install.sh

ENV MAVEN_HOME=/usr/lib/apache-maven-3.8.6
ENV JAVA_HOME=/opt/graalvm
ENV GRAALVM_HOME=/opt/graalvm
ENV PATH="${JAVA_HOME}/bin:${MAVEN_HOME}/bin:${PATH}"

RUN mvn clean package -DskipTests -Pnative

FROM haroldli/alist:latest

LABEL MAINTAINER="Har01d"

VOLUME /opt/atv/data/

WORKDIR /opt/atv/

COPY config/config.json /opt/alist/data/config.json

COPY atv-cli/atv-cli /
COPY index.sh /

COPY init.sh /
COPY movie.sh /
COPY entrypoint-native.sh /entrypoint.sh

COPY --from=BUILDER /app/target/atv ./

COPY data/version data/app_version

EXPOSE 4567 80

ENTRYPOINT ["/entrypoint.sh"]

CMD ["81", "--spring.profiles.active=production,xiaoya"]
